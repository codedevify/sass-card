<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cart – Thank Ewe Very Much</title>

  <!-- Tailwind & Fonts (like main page) -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://js.stripe.com/v3/"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #fff8f1;
      margin: 0;
      overflow-x: hidden;
    }

    /* Navbar (same as main page) */
    .navbar {
      background: #ff6f61;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      position: sticky;
      top: 0;
      z-index: 1000;
      padding: 1rem 0;
    }
    .navbar-brand {
      font-weight: 700;
      font-size: 1.5rem;
      color: white !important;
    }
    .nav-link {
      color: white !important;
      font-weight: 600;
      font-size: 1.1rem;
      transition: color 0.3s ease;
    }
    .nav-link:hover {
      color: #ffd166 !important;
    }
    .cart-badge {
      background: white;
      color: #ff6f61;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 0.7rem;
      margin-left: 5px;
    }

    /* Cart Page Styling */
    .cart-container {
      max-width: 800px;
      margin: 3rem auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
      padding: 2rem;
    }

    .cart-item {
      border-bottom: 1px solid #eee;
      padding: 1rem 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .cart-item h5 {
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
    }

    .cart-item p {
      color: #666;
      font-size: 0.95rem;
    }

    .total {
      font-size: 1.5rem;
      font-weight: 700;
      color: #ff6f61;
    }

    #card-element {
      background: white;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
    }

    #card-errors {
      color: red;
      margin-top: 10px;
    }

    .payment-section {
      display: none;
    }
    .payment-section.active {
      display: block;
    }

    .btn-primary {
      background-color: #ff6f61;
      color: white;
      border: none;
      border-radius: 25px;
      font-weight: 600;
      padding: 10px 25px;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background-color: #e55a50;
      transform: scale(1.05);
    }

    footer {
      background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
      color: white;
      padding: 3rem 1rem;
      text-align: center;
      margin-top: 4rem;
    }

    footer p {
      font-size: 1rem;
      opacity: 0.9;
    }

    footer a {
      color: #ffd166;
      text-decoration: none;
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar">
  <div class="container flex items-center justify-between px-4">
    <a class="navbar-brand" href="/">Thank Ewe Very Much</a>
    <ul class="flex space-x-6 items-center">
      <li><a class="nav-link" href="/">Home</a></li>
      <li><a class="nav-link" href="/cart.html">Cart</a></li>
      <li><a class="nav-link" href="/admin.html">Admin</a></li>
    </ul>
  </div>
</nav>

<!-- Cart Content -->
<div class="cart-container">
  <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Your Cart</h1>
  <div id="cart-items"></div>

  <form id="checkout-form" class="mt-8 border-t pt-6">
    <h3 class="text-2xl font-semibold mb-4 text-gray-800">Customer Information</h3>
    <div class="mb-4"><input type="text" id="name" class="form-control w-full p-3 border rounded-lg" placeholder="Full Name" required></div>
    <div class="mb-4"><input type="email" id="email" class="form-control w-full p-3 border rounded-lg" placeholder="Email" required></div>

    <h3 class="text-2xl font-semibold mb-4 text-gray-800">Payment Method</h3>
    <div class="flex space-x-4 mb-6">
      <label class="flex items-center space-x-2 cursor-pointer">
        <input type="radio" name="payment" id="stripe" checked>
        <span>Card</span>
      </label>
      <label class="flex items-center space-x-2 cursor-pointer">
        <input type="radio" name="payment" id="paypal">
        <span>PayPal</span>
      </label>
    </div>

    <div id="stripe-payment" class="payment-section active">
      <div id="card-element" class="mb-3"></div>
      <div id="card-errors" role="alert" class="mb-3"></div>
    </div>
    <div id="paypal-payment" class="payment-section">
      <div id="paypal-button-container" class="mb-3"></div>
    </div>

    <div class="flex justify-between items-center mt-6">
      <p class="total">Total: $<span id="total">0.00</span></p>
      <button type="submit" class="btn-primary text-lg">Pay Now</button>
    </div>
  </form>
</div>

<!-- Footer -->
<footer>
  <p>© 2025 Thank Ewe Very Much. All rights reserved.</p>
  <p class="mt-2">Real Cards for Real People! #ThankEweVeryMuch</p>
  <p class="mt-2">Follow us on <a href="https://x.com">#RealCardsRealPeople</a></p>
</footer>

<script>
  let stripe, elements, card;
  let paypalClientId = '';

  async function loadCart() {
    const res = await fetch('/api/cart');
    const items = await res.json();
    const container = document.getElementById('cart-items');
    let total = 0;

    if (!items.length) {
      container.innerHTML = '<p class="text-gray-500 text-center">Your cart is empty.</p>';
      document.getElementById('total').textContent = '0.00';
      return;
    }

    container.innerHTML = items.map(it => {
      const sub = it.product.price * it.quantity;
      total += sub;
      return `
        <div class="cart-item">
          <div>
            <h5>${it.product.name}</h5>
            <p>$${it.product.price.toFixed(2)} × ${it.quantity}</p>
          </div>
          <div class="font-semibold text-gray-700">$${sub.toFixed(2)}</div>
        </div>`;
    }).join('');

    document.getElementById('total').textContent = total.toFixed(2);
    initPayment(total);
  }

  async function initPayment(total) {
    const stripeRes = await fetch('/api/stripe/config');
    const stripeData = await stripeRes.json();
    if (stripeData.publishableKey) {
      stripe = Stripe(stripeData.publishableKey);
      elements = stripe.elements();
      card = elements.create('card');
      card.mount('#card-element');
      card.on('change', (e) => {
        document.getElementById('card-errors').textContent = e.error ? e.error.message : '';
      });
    }

    const paypalRes = await fetch('/api/paypal/config');
    const paypalData = await paypalRes.json();
    if (paypalData.clientId) {
      paypalClientId = paypalData.clientId;
      const script = document.createElement('script');
      script.src = `https://www.paypal.com/sdk/js?client-id=${paypalClientId}&currency=USD`;
      script.onload = () => renderPayPal(total);
      document.head.appendChild(script);
    }
  }

  function renderPayPal(total) {
    if (!paypalClientId) return;
    paypal.Buttons({
      createOrder: () => fetch('/api/paypal/create-order', {
        method: 'POST',
        body: JSON.stringify({ total }),
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(o => o.id),
      onApprove: (data) => fetch('/api/paypal/capture-order', {
        method: 'POST',
        body: JSON.stringify({ orderID: data.orderID }),
        headers: { 'Content-Type': 'application/json' }
      }).then(r => r.json()).then(() => finalize('paypal', '', data.orderID))
    }).render('#paypal-button-container');
  }

  document.querySelectorAll('[name="payment"]').forEach(r => {
    r.addEventListener('change', () => {
      document.getElementById('stripe-payment').classList.toggle('active', r.id === 'stripe');
      document.getElementById('paypal-payment').classList.toggle('active', r.id === 'paypal');
    });
  });

  document.getElementById('checkout-form').onsubmit = async e => {
    e.preventDefault();
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const method = document.querySelector('[name="payment"]:checked').id;
    const total = parseFloat(document.getElementById('total').textContent);

    if (!name || !email) return alert('Fill name and email');

    if (method === 'stripe') {
      const res = await fetch('/api/stripe/create-intent', {
        method: 'POST',
        body: JSON.stringify({ total }),
        headers: { 'Content-Type': 'application/json' }
      });
      const { clientSecret } = await res.json();
      const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, { payment_method: { card } });
      if (error) return document.getElementById('card-errors').textContent = error.message;
      finalize('stripe', paymentIntent.id);
    }
  };

  async function finalize(method, paymentIntentId = '', paypalOrderId = '') {
    const name = document.getElementById('name').value;
    const email = document.getElementById('email').value;

    const res = await fetch('/api/finalize-order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, paymentMethod: method, paymentIntentId, paypalOrderId })
    });
    const data = await res.json();
    if (data.success) {
      alert('Payment successful! Order confirmed.');
      window.location.href = '/';
    } else {
      alert('Error: ' + (data.error || 'unknown'));
    }
  }

  loadCart();
</script>
</body>
</html>

<!--
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cart – Thank Ewe Very Much</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body{background:#f8f9fa;}
    .cart-item{border-bottom:1px solid #ddd;padding:15px 0;display:flex;justify-content:space-between;align-items:center;}
    .total{font-size:1.5rem;font-weight:bold;color:#e91e63;}
    #card-element { background: white; padding: 12px; border: 1px solid #ddd; border-radius: 5px; }
    #card-errors { color: red; }
    .payment-section { display: none; }
    .payment-section.active { display: block; }
  </style>
</head>
<body>
<div class="container py-5">
  <h1 class="mb-4">Your Cart</h1>
  <div id="cart-items"></div>

  <form id="checkout-form" class="mt-5 border p-4 rounded bg-white">
    <h3 class="mb-3">Customer Information</h3>
    <div class="mb-3"><input type="text" id="name" class="form-control" placeholder="Full Name" required></div>
    <div class="mb-3"><input type="email" id="email" class="form-control" placeholder="Email" required></div>

    <h3 class="mb-3">Payment Method</h3>
    <div class="btn-group mb-3" role="group">
      <input type="radio" class="btn-check" name="payment" id="stripe" checked>
      <label class="btn btn-outline-primary" for="stripe">Card</label>
      <input type="radio" class="btn-check" name="payment" id="paypal">
      <label class="btn btn-outline-primary" for="paypal">PayPal</label>
    </div>

    <div id="stripe-payment" class="payment-section active">
      <div id="card-element" class="mb-3"></div>
      <div id="card-errors" role="alert" class="mb-3"></div>
    </div>
    <div id="paypal-payment" class="payment-section">
      <div id="paypal-button-container" class="mb-3"></div>
    </div>

    <div class="d-flex justify-content-between align-items-center">
      <p class="total">Total: $<span id="total">0.00</span></p>
      <button type="submit" class="btn btn-success btn-lg">Pay Now</button>
    </div>
  </form>
</div>

<script>
  let stripe, elements, card;
  let paypalClientId = '';

  async function loadCart() {
    const res = await fetch('/api/cart');
    const items = await res.json();
    const container = document.getElementById('cart-items');
    let total = 0;

    if (!items.length) {
      container.innerHTML = '<p class="text-muted">Your cart is empty.</p>';
      document.getElementById('total').textContent = '0.00';
      return;
    }

    container.innerHTML = items.map(it => {
      const sub = it.product.price * it.quantity;
      total += sub;
      return `<div class="cart-item"><div><h5>${it.product.name}</h5><p>$${it.product.price.toFixed(2)} × ${it.quantity}</p></div><div>$${sub.toFixed(2)}</div></div>`;
    }).join('');

    document.getElementById('total').textContent = total.toFixed(2);
    initPayment(total);
  }

  async function initPayment(total) {
    // Stripe
    const stripeRes = await fetch('/api/stripe/config');
    const stripeData = await stripeRes.json();
    if (stripeData.publishableKey) {
      stripe = Stripe(stripeData.publishableKey);
      elements = stripe.elements();
      card = elements.create('card');
      card.mount('#card-element');
      card.on('change', (e) => {
        document.getElementById('card-errors').textContent = e.error ? e.error.message : '';
      });
    }

    // PayPal
    const paypalRes = await fetch('/api/paypal/config');
    const paypalData = await paypalRes.json();
    if (paypalData.clientId) {
      paypalClientId = paypalData.clientId;
      const script = document.createElement('script');
      script.src = `https://www.paypal.com/sdk/js?client-id=${paypalClientId}&currency=USD`;
      script.onload = () => renderPayPal(total);
      document.head.appendChild(script);
    }
  }

  function renderPayPal(total) {
    if (!paypalClientId) return;
    paypal.Buttons({
      createOrder: () => fetch('/api/paypal/create-order', { method: 'POST', body: JSON.stringify({ total }), headers: { 'Content-Type': 'application/json' } }).then(r => r.json()).then(o => o.id),
      onApprove: (data) => fetch('/api/paypal/capture-order', { method: 'POST', body: JSON.stringify({ orderID: data.orderID }), headers: { 'Content-Type': 'application/json' } }).then(r => r.json()).then(() => finalize('paypal', '', data.orderID))
    }).render('#paypal-button-container');
  }

  document.querySelectorAll('[name="payment"]').forEach(r => {
    r.addEventListener('change', () => {
      document.getElementById('stripe-payment').classList.toggle('active', r.id === 'stripe');
      document.getElementById('paypal-payment').classList.toggle('active', r.id === 'paypal');
    });
  });

  document.getElementById('checkout-form').onsubmit = async e => {
    e.preventDefault();
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const method = document.querySelector('[name="payment"]:checked').id;
    const total = parseFloat(document.getElementById('total').textContent);

    if (!name || !email) return alert('Fill name and email');

    if (method === 'stripe') {
      const res = await fetch('/api/stripe/create-intent', { method: 'POST', body: JSON.stringify({ total }), headers: { 'Content-Type': 'application/json' } });
      const { clientSecret } = await res.json();
      const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, { payment_method: { card } });
      if (error) return document.getElementById('card-errors').textContent = error.message;
      finalize('stripe', paymentIntent.id);
    }
  };

  async function finalize(method, paymentIntentId = '', paypalOrderId = '') {
    const name = document.getElementById('name').value;
    const email = document.getElementById('email').value;

    const res = await fetch('/api/finalize-order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, paymentMethod: method, paymentIntentId, paypalOrderId })
    });
    const data = await res.json();
    if (data.success) {
      alert('Payment successful! Order confirmed.');
      window.location.href = '/';
    } else {
      alert('Error: ' + (data.error || 'unknown'));
    }
  }

  loadCart();
</script>
</body>
</html>
